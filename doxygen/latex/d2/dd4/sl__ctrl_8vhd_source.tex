\subsection{sl\+\_\+ctrl.\+vhd}
\label{sl__ctrl_8vhd_source}\index{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/src/wfm\+\_\+ram\+\_\+buffer/sl\+\_\+ctrl.\+vhd@{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/src/wfm\+\_\+ram\+\_\+buffer/sl\+\_\+ctrl.\+vhd}}

\begin{DoxyCode}
00001 \textcolor{keyword}{-- ---------------------------------------------------------------------------- }
00002 \textcolor{keyword}{-- FILE:    sl\_ctrl.vhd}
00003 \textcolor{keyword}{-- DESCRIPTION: writes to fifo even number of samples}
00004 \textcolor{keyword}{-- DATE:    Jan 25, 2015}
00005 \textcolor{keyword}{-- AUTHOR(s):   Lime Microsystems}
00006 \textcolor{keyword}{-- REVISIONS:}
00007 \textcolor{keyword}{-- ---------------------------------------------------------------------------- }
00008 \textcolor{vhdlkeyword}{library }\textcolor{keywordflow}{ieee};
00009 \textcolor{vhdlkeyword}{use }ieee.std\_logic\_1164.\textcolor{keywordflow}{all};
00010 \textcolor{vhdlkeyword}{use }ieee.numeric\_std.\textcolor{keywordflow}{all};
00011 
00012 
00013 \textcolor{keywordflow}{entity }sl_ctrl \textcolor{keywordflow}{is}
00014 \textcolor{keywordflow}{port}\textcolor{vhdlchar}{(}
00015     \textcolor{vhdlchar}{clk}     \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00016     \textcolor{vhdlchar}{rstn}    \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00017     \textcolor{vhdlchar}{wrreq}   \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00018     \textcolor{vhdlchar}{stream_load} \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00019     \textcolor{vhdlchar}{data}        \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{15} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00020     \textcolor{vhdlchar}{wrusedw}     \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{13} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00021     
00022     \textcolor{vhdlchar}{str_load_o}  \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic};
00023     \textcolor{vhdlchar}{wrreq_o}     \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic};
00024     \textcolor{vhdlchar}{data_o}      \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{15} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)}
00025 \textcolor{vhdlchar}{)};
00026 \textcolor{keywordflow}{end} \textcolor{vhdlchar}{sl\_ctrl};
00027 
00028 \textcolor{keywordflow}{architecture} arch \textcolor{keywordflow}{of} sl_ctrl is
00029     \textcolor{keywordflow}{constant} \textcolor{vhdlchar}{data_const} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{15} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)} \textcolor{vhdlchar}{:=} \textcolor{vhdlchar}{x}\textcolor{vhdllogic}{"8000"};\textcolor{keyword}{ -- default data value}
00030     
00031     \textcolor{keywordflow}{type} \textcolor{vhdlchar}{state_type} \textcolor{keywordflow}{is} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{s0}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s1}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s2}\textcolor{vhdlchar}{)};
00032     
00033     \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{f_r}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{f_n}     \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};\textcolor{keyword}{        -- flag register for rising edge detection}
00034     \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{s_r}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s_n}     \textcolor{vhdlchar}{:} \textcolor{vhdlchar}{state_type};\textcolor{keyword}{       -- state register}
00035     \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{sl_r}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{sl_n} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};\textcolor{keyword}{      -- delay register}
00036     \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{r_edge}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{edge}     \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};\textcolor{keyword}{            -- signal for rising edge detection}
00037     \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{delay_r}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{delay_n} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{7} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00038 \textcolor{vhdlkeyword}{begin}
00039     reg\_proc : \textcolor{keywordflow}{process}(clk, rstn)
00040 \textcolor{vhdlkeyword}{    begin}
00041         \textcolor{keywordflow}{if} \textcolor{vhdlchar}{rstn} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00042             \textcolor{vhdlchar}{f_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'};
00043             \textcolor{vhdlchar}{sl_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'};
00044             \textcolor{vhdlchar}{s_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s0};
00045             \textcolor{vhdlchar}{delay_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{(}\textcolor{keywordflow}{others} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)};
00046         \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{rising\_edge}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00047             \textcolor{vhdlchar}{f_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{f_n};
00048             \textcolor{vhdlchar}{sl_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{sl_n};
00049             \textcolor{vhdlchar}{s_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s_n};
00050             \textcolor{vhdlchar}{delay_r} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{delay_n};
00051         \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00052     \textcolor{keywordflow}{end} \textcolor{keywordflow}{process} \textcolor{vhdlchar}{reg\_proc};
00053     
00054     \textcolor{vhdlchar}{f_n}     \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{stream_load};\textcolor{keyword}{                 -- shift in stream\_load signal into flag register}
00055     \textcolor{vhdlchar}{edge}    \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{stream_load} \textcolor{keywordflow}{xor} \textcolor{vhdlchar}{f_r};\textcolor{keyword}{ -- detect rising edge and decide if write operation is neccessary}
00056     \textcolor{vhdlchar}{r_edge} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{stream_load} \textcolor{keywordflow}{and} \textcolor{keywordflow}{not}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{f_r}\textcolor{vhdlchar}{)};
00057     \textcolor{vhdlchar}{sl_n} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{stream_load} \textcolor{keywordflow}{when} \textcolor{vhdlchar}{edge} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{else} \textcolor{vhdlchar}{sl_r};
00058     
00059     \textcolor{vhdlchar}{delay_n} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{delay_r}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{6} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)} \textcolor{vhdlchar}{&} \textcolor{vhdlchar}{sl_n};
00060     
00061 \textcolor{keyword}{    -- control process}
00062     ctrl\_proc : \textcolor{keywordflow}{process}(r_edge, wrusedw, s_r, stream_load, data, wrreq)
00063 \textcolor{vhdlkeyword}{    begin}
00064     \textcolor{vhdlchar}{s_n}     \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s_r};
00065     \textcolor{vhdlchar}{data_o} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{data};
00066     \textcolor{vhdlchar}{wrreq_o} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{wrreq};
00067         \textcolor{keywordflow}{case} \textcolor{vhdlchar}{s_r} \textcolor{keywordflow}{is}
00068             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s0} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00069                 \textcolor{keywordflow}{if} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{r_edge} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{wrusedw}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)} \textcolor{vhdlchar}{/=} \textcolor{vhdllogic}{"00"}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{or} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{wrusedw}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)} \textcolor{vhdlchar}{/=} \textcolor{vhdllogic}{"11"}\textcolor{vhdlchar}{)}\textcolor{vhdlchar}{)}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}\textcolor{keyword}{
       -- if rising edge detected}
00070                     \textcolor{vhdlchar}{s_n}       \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s1};\textcolor{keyword}{        -- jump to the second cycle}
00071                 \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00072             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s1} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00073                 \textcolor{vhdlchar}{wrreq_o}  \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'};\textcolor{keyword}{            -- assert write req.}
00074                 \textcolor{vhdlchar}{data_o}  \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{data_const};\textcolor{keyword}{  -- with data accompanying it}
00075                 \textcolor{vhdlchar}{s_n}     \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s2};\textcolor{keyword}{      -- jump to the idle state}
00076             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s2} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00077                 \textcolor{vhdlchar}{wrreq_o}  \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'};\textcolor{keyword}{            -- assert write req.}
00078                 \textcolor{vhdlchar}{data_o}  \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{data_const};\textcolor{keyword}{  -- with data accompanying it}
00079                 \textcolor{vhdlchar}{s_n}     \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s0};\textcolor{keyword}{      -- jump to the idle state}
00080             \textcolor{keywordflow}{when} \textcolor{keywordflow}{others} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00081                 \textcolor{vhdlchar}{s_n} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s0};
00082         \textcolor{keywordflow}{end} \textcolor{keywordflow}{case};
00083     \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00084 
00085     \textcolor{vhdlchar}{str_load_o} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{delay_r}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{7}\textcolor{vhdlchar}{)};\textcolor{keyword}{   -- output delayed by eigth clock cycles}
00086 \textcolor{keywordflow}{end} \textcolor{vhdlchar}{arch};
\end{DoxyCode}
