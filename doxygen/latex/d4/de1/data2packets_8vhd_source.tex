\subsection{data2packets.\+vhd}
\label{data2packets_8vhd_source}\index{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/src/rx\+\_\+path\+\_\+top/data2packets/synth/data2packets.\+vhd@{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/src/rx\+\_\+path\+\_\+top/data2packets/synth/data2packets.\+vhd}}

\begin{DoxyCode}
00001 \textcolor{keyword}{-- ---------------------------------------------------------------------------- }
00002 \textcolor{keyword}{-- FILE:    data2packets.vhd}
00003 \textcolor{keyword}{-- DESCRIPTION: Forms packets with provided header.}
00004 \textcolor{keyword}{-- DATE:    Jan 27, 2016}
00005 \textcolor{keyword}{-- AUTHOR(s):   Lime Microsystems}
00006 \textcolor{keyword}{-- REVISIONS:}
00007 \textcolor{keyword}{-- ---------------------------------------------------------------------------- }
00008 
00009 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00010 \textcolor{keyword}{-- Notes:}
00011 \textcolor{keyword}{-- pct\_size MIN 6words}
00012 \textcolor{keyword}{-- pct\_data words in packet = pct\_size - 2 }
00013 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00014 
00015 \textcolor{vhdlkeyword}{library }\textcolor{keywordflow}{ieee};
00016 \textcolor{vhdlkeyword}{use }ieee.std\_logic\_1164.\textcolor{keywordflow}{all};
00017 \textcolor{vhdlkeyword}{use }ieee.numeric\_std.\textcolor{keywordflow}{all};
00018 
00019 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00020 \textcolor{keyword}{-- Entity declaration}
00021 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00022 \textcolor{keywordflow}{entity }data2packets \textcolor{keywordflow}{is}
00023    \textcolor{keywordflow}{generic} \textcolor{vhdlchar}{(}
00024       \textcolor{vhdlchar}{pct_size_w}        \textcolor{vhdlchar}{:} \textcolor{comment}{integer} \textcolor{vhdlchar}{:=} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{15}
00025    \textcolor{vhdlchar}{)};
00026    \textcolor{keywordflow}{port} \textcolor{vhdlchar}{(}
00027 
00028       \textcolor{vhdlchar}{clk}               \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00029       \textcolor{vhdlchar}{reset_n}           \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};
00030       \textcolor{vhdlchar}{pct_size}          \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{pct_size_w}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};\textcolor{keyword}{ --Whole packet size in 64b words (MIN
       6words)}
00031       \textcolor{vhdlchar}{pct_hdr_0}         \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00032       \textcolor{vhdlchar}{pct_hdr_1}         \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00033         \textcolor{vhdlchar}{pct_ftr_0}           \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00034         \textcolor{vhdlchar}{pct_ftr_1}           \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00035       \textcolor{vhdlchar}{pct_data}          \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00036       \textcolor{vhdlchar}{pct_data_wrreq}    \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic};\textcolor{keyword}{                     -- Do not assert when pct\_state="11"}
00037       \textcolor{vhdlchar}{pct_state}         \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};\textcolor{keyword}{ -- 00 - Idle}
00038 \textcolor{keyword}{                                                            -- 01 - Data capture}
00039 \textcolor{keyword}{                                                            -- 10 - Last packet word accepted}
00040 \textcolor{keyword}{                                                            -- 11 - Busy}
00041 
00042       \textcolor{vhdlchar}{pct_wrreq}         \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic};
00043       \textcolor{vhdlchar}{pct_q}             \textcolor{vhdlchar}{:} \textcolor{keywordflow}{out} \textcolor{comment}{std\_logic\_vector}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00044         \textcolor{vhdlchar}{chirp_sync_en}       \textcolor{vhdlchar}{:} \textcolor{keywordflow}{in} \textcolor{comment}{std\_logic}
00045       
00046         \textcolor{vhdlchar}{)};
00047 \textcolor{keywordflow}{end} \textcolor{vhdlchar}{data2packets};
00048 
00049 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00050 \textcolor{keyword}{-- Architecture}
00051 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00052 \textcolor{keywordflow}{architecture} arch \textcolor{keywordflow}{of} data2packets is
00053 \textcolor{keyword}{--declare signals,  components here}
00054 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_0}      \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic\_vector} \textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)}; 
00055 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_1}      \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic\_vector} \textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)}; 
00056 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_2}      \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic\_vector} \textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{63} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)}; 
00057 
00058 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_0_ld}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00059 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_0_ld_f} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00060 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_1_ld}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00061 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_1_ld_f} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00062 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_2_ld}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00063 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_2_ld_f} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00064 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_ld}     \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00065 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_ld_ftr}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00066 
00067 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_0_en}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00068 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_1_en}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00069 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_2_en}   \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00070 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{reg_en}     \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00071 
00072 \textcolor{keywordflow}{type} \textcolor{vhdlchar}{state_type} \textcolor{keywordflow}{is} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{idle}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s0}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s1}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s2}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{s3}\textcolor{vhdlchar}{)};
00073 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{current_state}\textcolor{vhdlchar}{,} \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{:} \textcolor{vhdlchar}{state_type};
00074 
00075 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_data_wr_cnt}     \textcolor{vhdlchar}{:} \textcolor{comment}{unsigned}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{pct_size_w}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00076 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_data_wr_cnt_max} \textcolor{vhdlchar}{:} \textcolor{comment}{unsigned}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{pct_size_w}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00077 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_data_wr_cnt_en}  \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00078 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_data_wr_cnt_clr} \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00079 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_end_cnt}         \textcolor{vhdlchar}{:} \textcolor{comment}{unsigned}\textcolor{vhdlchar}{(}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{7} \textcolor{keywordflow}{downto} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{)};
00080 
00081 \textcolor{keywordflow}{signal} \textcolor{vhdlchar}{pct_wrreq_int}       \textcolor{vhdlchar}{:} \textcolor{comment}{std\_logic};
00082 
00083   
00084 \textcolor{vhdlkeyword}{begin}
00085 
00086 
00087 \textcolor{vhdlchar}{pct_data_wr_cnt_en}  \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{pct_data_wrreq};
00088 \textcolor{vhdlchar}{pct_data_wr_cnt_clr} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{when} \textcolor{vhdlchar}{current_state} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{s2} \textcolor{keywordflow}{else} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'};
00089 
00090 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00091 \textcolor{keyword}{-- Max packet write value}
00092 \textcolor{keyword}{-- ----------------------------------------------------------------------------  }
00093 pct\_data\_wr\_cnt\_max\_proc : \textcolor{keywordflow}{process}(reset_n, clk)
00094 \textcolor{vhdlkeyword}{   begin}
00095       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00096          \textcolor{vhdlchar}{pct_data_wr_cnt_max} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{(}\textcolor{keywordflow}{others}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)};
00097       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00098             \textcolor{keywordflow}{if} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{chirp_sync_en}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00099          \textcolor{vhdlchar}{pct_data_wr_cnt_max} \textcolor{vhdlchar}{<=} \textcolor{comment}{unsigned}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{pct_size}\textcolor{vhdlchar}{)}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{4};
00100             \textcolor{keywordflow}{else}
00101             \textcolor{vhdlchar}{pct_data_wr_cnt_max} \textcolor{vhdlchar}{<=} \textcolor{comment}{unsigned}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{pct_size}\textcolor{vhdlchar}{)}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{6};
00102             \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00103       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00104    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00105 
00106 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00107 \textcolor{keyword}{-- Delay packet write signal counter}
00108 \textcolor{keyword}{-- ----------------------------------------------------------------------------     }
00109 pct\_end\_cnt\_proc : \textcolor{keywordflow}{process}(reset_n, clk)
00110 \textcolor{vhdlkeyword}{   begin}
00111       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00112          \textcolor{vhdlchar}{pct_end_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{(}\textcolor{keywordflow}{others}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)};
00113       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00114          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{current_state} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{s2} \textcolor{keywordflow}{then}
00115             \textcolor{vhdlchar}{pct_end_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{pct_end_cnt}\textcolor{vhdlchar}{-}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1};
00116          \textcolor{keywordflow}{else}
00117                 \textcolor{keywordflow}{if} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{chirp_sync_en}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00118             \textcolor{vhdlchar}{pct_end_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{x}\textcolor{vhdllogic}{"01"};
00119                 \textcolor{keywordflow}{else}
00120                 \textcolor{vhdlchar}{pct_end_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{x}\textcolor{vhdllogic}{"03"};
00121                 \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00122          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00123       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00124    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00125  
00126 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00127 \textcolor{keyword}{-- Write packet counter}
00128 \textcolor{keyword}{-- ----------------------------------------------------------------------------  }
00129 pct\_data\_wr\_cnt\_proc : \textcolor{keywordflow}{process}(reset_n, clk)
00130 \textcolor{vhdlkeyword}{   begin}
00131       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00132          \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{(}\textcolor{keywordflow}{others}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)};
00133       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00134          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wr_cnt_clr} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00135             \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{(}\textcolor{keywordflow}{others}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)};
00136          \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{pct_data_wr_cnt_en} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00137             \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{+} \textcolor{vhdllogic}{}\textcolor{vhdllogic}{1};
00138          \textcolor{keywordflow}{else} 
00139             \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{pct_data_wr_cnt};
00140          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00141       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00142    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00143    
00144   
00145    reg\_ld <= '1' \textcolor{keywordflow}{when} current\_state = idle \textcolor{keywordflow}{AND} pct\_data\_wrreq='1' \textcolor{keywordflow}{else} '0';
00146     reg\_ld\_ftr <= '1' \textcolor{keywordflow}{when} current\_state = S2 \textcolor{keywordflow}{AND} chirp\_sync\_en='1' \textcolor{keywordflow}{AND} pct\_end\_cnt= x"01" \textcolor{keywordflow}{else} '0';
00147    reg\_en <= '1' \textcolor{keywordflow}{when} current\_state = S2 \textcolor{keywordflow}{OR} pct\_data\_wrreq='1' \textcolor{keywordflow}{else} '0';
00148    
00149 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00150 \textcolor{keyword}{-- Register stage 0}
00151 \textcolor{keyword}{-- ----------------------------------------------------------------------------   }
00152    reg\_0\_ld <= reg\_ld;
00153     reg\_0\_ld\_f <= reg\_ld\_ftr;
00154    reg\_0\_en <= reg\_en;
00155 
00156  reg\_stage\_0 : \textcolor{keywordflow}{process}(reset_n, clk)
00157 \textcolor{vhdlkeyword}{   begin}
00158       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00159          reg\_0 <= (others=>'0');
00160       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00161          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reg_0_ld} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00162             reg\_0 <= pct\_hdr\_0;
00163             \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{reg_0_ld_f} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00164                 reg\_0 <= pct\_ftr\_0;
00165          \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{reg_0_en} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00166             reg\_0 <= reg\_1;
00167          \textcolor{keywordflow}{else} 
00168             reg\_0 <= reg\_0;
00169          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00170       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00171    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00172    
00173 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00174 \textcolor{keyword}{-- Register stage 1}
00175 \textcolor{keyword}{-- ----------------------------------------------------------------------------  }
00176    
00177 reg\_1\_ld <= reg\_ld;
00178 reg\_1\_ld\_f <= reg\_ld\_ftr;
00179 reg\_1\_en <= reg\_en;
00180    
00181  reg\_stage\_1 :  \textcolor{keywordflow}{process}(reset_n, clk)
00182 \textcolor{vhdlkeyword}{   begin}
00183       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00184          reg\_1 <= (others=>'0');
00185       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00186          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reg_1_ld} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00187             reg\_1 <= pct\_hdr\_1;
00188             \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{reg_1_ld_f} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00189                 reg\_1 <= pct\_ftr\_1;
00190          \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{reg_1_en} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00191             reg\_1 <= reg\_2;
00192          \textcolor{keywordflow}{else} 
00193             reg\_1 <= reg\_1;
00194          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00195       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00196    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00197    
00198 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00199 \textcolor{keyword}{-- Register stage 2}
00200 \textcolor{keyword}{-- ----------------------------------------------------------------------------  }
00201    
00202 reg\_2\_ld <= pct\_data\_wrreq;
00203 reg\_2\_ld\_f <= reg\_ld\_ftr;
00204 reg\_2\_en <= '0';
00205    
00206  reg\_stage\_2 :  \textcolor{keywordflow}{process}(reset_n, clk)
00207 \textcolor{vhdlkeyword}{   begin}
00208       \textcolor{keywordflow}{if} \textcolor{vhdlchar}{reset_n}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00209          reg\_2 <= (others=>'0');
00210       \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00211             \textcolor{keywordflow}{if} \textcolor{vhdlchar}{(}\textcolor{vhdlchar}{reg_2_ld_f} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)} \textcolor{keywordflow}{then}
00212                 reg\_2 <= reg\_2;
00213          \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{reg_2_ld} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00214             reg\_2 <= pct\_data;          
00215          \textcolor{keywordflow}{elsif} \textcolor{vhdlchar}{reg_2_en} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00216             reg\_2 <= reg\_2;
00217          \textcolor{keywordflow}{else} 
00218             reg\_2 <= reg\_2;
00219          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00220       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00221    \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00222    
00223 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00224 \textcolor{keyword}{--state machine}
00225 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00226 fsm\_f : \textcolor{keywordflow}{process}(clk, reset_n)\textcolor{keywordflow}{begin}
00227     \textcolor{keywordflow}{if}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{reset_n} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)}\textcolor{keywordflow}{then}
00228         \textcolor{vhdlchar}{current_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{idle};
00229     \textcolor{keywordflow}{elsif}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)}\textcolor{keywordflow}{then} 
00230         \textcolor{vhdlchar}{current_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{next_state};
00231     \textcolor{keywordflow}{end} \textcolor{keywordflow}{if}; 
00232 \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00233 
00234 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00235 \textcolor{keyword}{--state machine combo}
00236 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00237 fsm : \textcolor{keywordflow}{process}(current_state, pct_data_wrreq, pct_data_wr_cnt, 
      pct_data_wr_cnt_max, pct_end_cnt) \textcolor{keywordflow}{begin}
00238     \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{current_state};
00239     \textcolor{keywordflow}{case} \textcolor{vhdlchar}{current_state} \textcolor{keywordflow}{is}
00240       
00241         \textcolor{keywordflow}{when} \textcolor{vhdlchar}{idle} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{keyword}{ -- state}
00242          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wrreq} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00243             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s0};
00244          \textcolor{keywordflow}{else} 
00245             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{idle};
00246          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00247          
00248       \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s0} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{keyword}{ -- state}
00249          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wr_cnt} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{pct_data_wr_cnt_max} \textcolor{keywordflow}{AND} \textcolor{vhdlchar}{pct_data_wrreq} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00250             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s1};
00251          \textcolor{keywordflow}{else} 
00252             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s0};
00253          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00254          
00255       \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s1} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{keyword}{ -- state}
00256          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wrreq} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then} 
00257             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s2};
00258          \textcolor{keywordflow}{else} 
00259             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s1};
00260          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00261         
00262       \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s2} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}\textcolor{keyword}{ -- state}
00263          \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_end_cnt} \textcolor{vhdlchar}{=} \textcolor{vhdllogic}{"00"} \textcolor{keywordflow}{then} 
00264             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{idle};
00265          \textcolor{keywordflow}{else} 
00266             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{s2};
00267          \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00268             
00269         \textcolor{keywordflow}{when} \textcolor{keywordflow}{others} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>} 
00270             \textcolor{vhdlchar}{next_state} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{idle};
00271     \textcolor{keywordflow}{end} \textcolor{keywordflow}{case};
00272 \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00273 
00274  pct\_wrreq\_int\_proc : \textcolor{keywordflow}{process}(clk, reset_n)\textcolor{keywordflow}{begin}
00275     \textcolor{keywordflow}{if}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{reset_n} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)}\textcolor{keywordflow}{then}
00276         \textcolor{vhdlchar}{pct_wrreq_int} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'};
00277     \textcolor{keywordflow}{elsif}\textcolor{vhdlchar}{(}\textcolor{vhdlchar}{clk}\textcolor{vhdlchar}{'}\textcolor{vhdlkeyword}{event} \textcolor{keywordflow}{and} \textcolor{vhdlchar}{clk} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'}\textcolor{vhdlchar}{)}\textcolor{keywordflow}{then} 
00278         \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wrreq} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{OR} \textcolor{vhdlchar}{current_state} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{s2} \textcolor{keywordflow}{then} 
00279          \textcolor{vhdlchar}{pct_wrreq_int} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'};
00280       \textcolor{keywordflow}{else} 
00281          \textcolor{vhdlchar}{pct_wrreq_int} \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{0}\textcolor{vhdlchar}{'};
00282       \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00283     \textcolor{keywordflow}{end} \textcolor{keywordflow}{if}; 
00284 \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00285 
00286 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00287 \textcolor{keyword}{-- pct\_state decoding}
00288 \textcolor{keyword}{-- ----------------------------------------------------------------------------}
00289 \textcolor{keywordflow}{process} (current_state, pct_data_wrreq)
00290 \textcolor{vhdlkeyword}{    begin}
00291         \textcolor{keywordflow}{case} \textcolor{vhdlchar}{current_state} \textcolor{keywordflow}{is}
00292             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{idle} \textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00293             \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"00"};
00294             
00295             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s0}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00296             \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"01"};
00297             
00298             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s1}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00299                 \textcolor{keywordflow}{if} \textcolor{vhdlchar}{pct_data_wrreq} \textcolor{vhdlchar}{=} \textcolor{vhdlchar}{'}\textcolor{vhdllogic}{}\textcolor{vhdllogic}{1}\textcolor{vhdlchar}{'} \textcolor{keywordflow}{then}
00300                \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"10"};
00301                 \textcolor{keywordflow}{else}
00302                \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"01"};
00303                 \textcolor{keywordflow}{end} \textcolor{keywordflow}{if};
00304             
00305             \textcolor{keywordflow}{when} \textcolor{vhdlchar}{s2}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>}
00306             \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"11"};
00307             
00308          \textcolor{keywordflow}{when} \textcolor{keywordflow}{others}\textcolor{vhdlchar}{=}\textcolor{vhdlchar}{>} 
00309             \textcolor{vhdlchar}{pct_state} \textcolor{vhdlchar}{<=} \textcolor{vhdllogic}{"11"};
00310             
00311         \textcolor{keywordflow}{end} \textcolor{keywordflow}{case};
00312     \textcolor{keywordflow}{end} \textcolor{keywordflow}{process};
00313    
00314 \textcolor{vhdlchar}{pct_wrreq}   \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{pct_wrreq_int};
00315 \textcolor{vhdlchar}{pct_q}       \textcolor{vhdlchar}{<=} \textcolor{vhdlchar}{reg_0};
00316   
00317 \textcolor{keywordflow}{end} \textcolor{vhdlchar}{arch};   
00318 
00319 
00320 
00321 
00322 
\end{DoxyCode}
