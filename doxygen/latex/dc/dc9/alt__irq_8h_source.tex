\subsection{alt\+\_\+irq.\+h}
\label{alt__irq_8h_source}\index{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/software/lms\+\_\+ctr\+\_\+bsp/\+H\+A\+L/inc/sys/alt\+\_\+irq.\+h@{/home/erik/git/dev/\+Lime\+S\+D\+R-\/\+U\+S\+B\+\_\+\+G\+W/software/lms\+\_\+ctr\+\_\+bsp/\+H\+A\+L/inc/sys/alt\+\_\+irq.\+h}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#ifndef \_\_ALT\_IRQ\_H\_\_}
00002 \textcolor{preprocessor}{#define \_\_ALT\_IRQ\_H\_\_}
00003 
00004 \textcolor{comment}{/******************************************************************************}
00005 \textcolor{comment}{*                                                                             *}
00006 \textcolor{comment}{* License Agreement                                                           *}
00007 \textcolor{comment}{*                                                                             *}
00008 \textcolor{comment}{* Copyright (c) 2009 Altera Corporation, San Jose, California, USA.           *}
00009 \textcolor{comment}{* All rights reserved.                                                        *}
00010 \textcolor{comment}{*                                                                             *}
00011 \textcolor{comment}{* Permission is hereby granted, free of charge, to any person obtaining a     *}
00012 \textcolor{comment}{* copy of this software and associated documentation files (the "Software"),  *}
00013 \textcolor{comment}{* to deal in the Software without restriction, including without limitation   *}
00014 \textcolor{comment}{* the rights to use, copy, modify, merge, publish, distribute, sublicense,    *}
00015 \textcolor{comment}{* and/or sell copies of the Software, and to permit persons to whom the       *}
00016 \textcolor{comment}{* Software is furnished to do so, subject to the following conditions:        *}
00017 \textcolor{comment}{*                                                                             *}
00018 \textcolor{comment}{* The above copyright notice and this permission notice shall be included in  *}
00019 \textcolor{comment}{* all copies or substantial portions of the Software.                         *}
00020 \textcolor{comment}{*                                                                             *}
00021 \textcolor{comment}{* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  *}
00022 \textcolor{comment}{* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    *}
00023 \textcolor{comment}{* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE *}
00024 \textcolor{comment}{* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER      *}
00025 \textcolor{comment}{* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING     *}
00026 \textcolor{comment}{* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER         *}
00027 \textcolor{comment}{* DEALINGS IN THE SOFTWARE.                                                   *}
00028 \textcolor{comment}{*                                                                             *}
00029 \textcolor{comment}{* This agreement shall be governed in all respects by the laws of the State   *}
00030 \textcolor{comment}{* of California and by the laws of the United States of America.              *}
00031 \textcolor{comment}{*                                                                             *}
00032 \textcolor{comment}{******************************************************************************/}
00033 
00034 \textcolor{comment}{/*}
00035 \textcolor{comment}{ * alt\_irq.h is the Nios II specific implementation of the interrupt controller }
00036 \textcolor{comment}{ * interface.}
00037 \textcolor{comment}{ *}
00038 \textcolor{comment}{ * Nios II includes optional support for an external interrupt controller. }
00039 \textcolor{comment}{ * When an external controller is present, the "Enhanced" interrupt API}
00040 \textcolor{comment}{ * must be used to manage individual interrupts. The enhanced API also}
00041 \textcolor{comment}{ * supports the processor's internal interrupt controller. Certain API}
00042 \textcolor{comment}{ * members are accessible from either the "legacy" or "enhanced" interrpt}
00043 \textcolor{comment}{ * API. }
00044 \textcolor{comment}{ *}
00045 \textcolor{comment}{ * Regardless of which API is in use, this file should be included by}
00046 \textcolor{comment}{ * application code and device drivers that register ISRs or manage interrpts.}
00047 \textcolor{comment}{ */}
00048 \textcolor{preprocessor}{#include <errno.h>}
00049 
00050 \textcolor{preprocessor}{#include "nios2.h"}
00051 \textcolor{preprocessor}{#include "alt_types.h"}
00052 \textcolor{preprocessor}{#include "system.h"}
00053 
00054 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00055 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"}
00056 \{
00057 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* \_\_cplusplus */}\textcolor{preprocessor}{}
00058 
00059 \textcolor{comment}{/*}
00060 \textcolor{comment}{ * Macros used by alt\_irq\_enabled}
00061 \textcolor{comment}{ */}
00062 \textcolor{preprocessor}{#define ALT\_IRQ\_ENABLED  1}
00063 \textcolor{preprocessor}{#define ALT\_IRQ\_DISABLED 0  }
00064 
00065 \textcolor{comment}{/* }
00066 \textcolor{comment}{ * Number of available interrupts in internal interrupt controller.}
00067 \textcolor{comment}{ */}
00068 \textcolor{preprocessor}{#define ALT\_NIRQ NIOS2\_NIRQ}
00069 
00070 \textcolor{comment}{/*}
00071 \textcolor{comment}{ * Used by alt\_irq\_disable\_all() and alt\_irq\_enable\_all().}
00072 \textcolor{comment}{ */}
00073 \textcolor{keyword}{typedef} \textcolor{keywordtype}{int} alt_irq_context;
00074 
00075 \textcolor{comment}{/* ISR Prototype */}
00076 \textcolor{preprocessor}{#ifdef ALT\_ENHANCED\_INTERRUPT\_API\_PRESENT}
00077 \textcolor{keyword}{typedef} void (*alt_isr_func)(\textcolor{keywordtype}{void}* isr\_context);
00078 \textcolor{preprocessor}{#else}
00079 \textcolor{keyword}{typedef} void (*alt_isr_func)(\textcolor{keywordtype}{void}* isr\_context, alt_u32 id);
00080 \textcolor{preprocessor}{#endif}
00081 
00082 \textcolor{comment}{/*}
00083 \textcolor{comment}{ * The following protypes and routines are supported by both}
00084 \textcolor{comment}{ * the enhanced and legacy interrupt APIs}
00085 \textcolor{comment}{ */}
00086  
00087 \textcolor{comment}{/*}
00088 \textcolor{comment}{ * alt\_irq\_enabled can be called to determine if the processor's global}
00089 \textcolor{comment}{ * interrupt enable is asserted. The return value is zero if interrupts }
00090 \textcolor{comment}{ * are disabled, and non-zero otherwise.}
00091 \textcolor{comment}{ *}
00092 \textcolor{comment}{ * Whether the internal or external interrupt controller is present, }
00093 \textcolor{comment}{ * individual interrupts may still be disabled. Use the other API to query}
00094 \textcolor{comment}{ * a specific interrupt. }
00095 \textcolor{comment}{ */}
00096 \textcolor{keyword}{static} ALT_INLINE \textcolor{keywordtype}{int} ALT_ALWAYS_INLINE alt_irq_enabled (\textcolor{keywordtype}{void})
00097 \{
00098   \textcolor{keywordtype}{int} status;
00099 
00100   NIOS2_READ_STATUS (status);
00101 
00102   \textcolor{keywordflow}{return} status & NIOS2_STATUS_PIE_MSK; 
00103 \}
00104 
00105 \textcolor{comment}{/*}
00106 \textcolor{comment}{ * alt\_irq\_disable\_all() }
00107 \textcolor{comment}{ *}
00108 \textcolor{comment}{ * This routine inhibits all interrupts by negating the status register PIE }
00109 \textcolor{comment}{ * bit. It returns the previous contents of the CPU status register (IRQ }
00110 \textcolor{comment}{ * context) which can be used to restore the status register PIE bit to its }
00111 \textcolor{comment}{ * state before this routine was called.}
00112 \textcolor{comment}{ */}
00113 \textcolor{keyword}{static} ALT_INLINE alt\_irq\_context ALT_ALWAYS_INLINE 
00114        alt_irq_disable_all (\textcolor{keywordtype}{void})
00115 \{
00116   alt\_irq\_context context;
00117 
00118   NIOS2_READ_STATUS (context);
00119 
00120   NIOS2_WRITE_STATUS (context & ~NIOS2_STATUS_PIE_MSK);
00121   
00122   \textcolor{keywordflow}{return} context;
00123 \}
00124 
00125 \textcolor{comment}{/*}
00126 \textcolor{comment}{ * alt\_irq\_enable\_all() }
00127 \textcolor{comment}{ *}
00128 \textcolor{comment}{ * Enable all interrupts that were previously disabled by alt\_irq\_disable\_all()}
00129 \textcolor{comment}{ *}
00130 \textcolor{comment}{ * This routine accepts a context to restore the CPU status register PIE bit}
00131 \textcolor{comment}{ * to the state prior to a call to alt\_irq\_disable\_all().}
00132 \textcolor{comment}{ }
00133 \textcolor{comment}{ * In the case of nested calls to alt\_irq\_disable\_all()/alt\_irq\_enable\_all(), }
00134 \textcolor{comment}{ * this means that alt\_irq\_enable\_all() does not necessarily re-enable}
00135 \textcolor{comment}{ * interrupts.}
00136 \textcolor{comment}{ *}
00137 \textcolor{comment}{ * This routine will perform a read-modify-write sequence to restore only}
00138 \textcolor{comment}{ * status.PIE if the processor is configured with options that add additional }
00139 \textcolor{comment}{ * writeable status register bits. These include the MMU, MPU, the enhanced }
00140 \textcolor{comment}{ * interrupt controller port, and shadow registers. Otherwise, as a performance}
00141 \textcolor{comment}{ * enhancement, status is overwritten with the prior context. }
00142 \textcolor{comment}{ */}
00143 \textcolor{keyword}{static} ALT_INLINE \textcolor{keywordtype}{void} ALT_ALWAYS_INLINE 
00144        alt_irq_enable_all (alt\_irq\_context context)
00145 \{
00146 \textcolor{preprocessor}{#if (NIOS2\_NUM\_OF\_SHADOW\_REG\_SETS > 0) || (defined NIOS2\_EIC\_PRESENT) || \(\backslash\)}
00147 \textcolor{preprocessor}{    (defined NIOS2\_MMU\_PRESENT) || (defined NIOS2\_MPU\_PRESENT)}
00148   alt\_irq\_context status;
00149   
00150   NIOS2_READ_STATUS (status);
00151   
00152   status &= ~NIOS2_STATUS_PIE_MSK;
00153   status |= (context & NIOS2_STATUS_PIE_MSK);
00154   
00155   NIOS2_WRITE_STATUS (status);
00156 \textcolor{preprocessor}{#else}
00157   NIOS2_WRITE_STATUS (context);
00158 \textcolor{preprocessor}{#endif}
00159 \}
00160 
00161 \textcolor{comment}{/*}
00162 \textcolor{comment}{ * The function alt\_irq\_init() is defined within the auto-generated file}
00163 \textcolor{comment}{ * alt\_sys\_init.c. This function calls the initilization macros for all}
00164 \textcolor{comment}{ * interrupt controllers in the system at config time, before any other}
00165 \textcolor{comment}{ * non-interrupt controller driver is initialized.}
00166 \textcolor{comment}{ *}
00167 \textcolor{comment}{ * The "base" parameter is ignored and only present for backwards-compatibility.}
00168 \textcolor{comment}{ * It is recommended that NULL is passed in for the "base" parameter.}
00169 \textcolor{comment}{ */}
00170 \textcolor{keyword}{extern} \textcolor{keywordtype}{void} alt_irq_init (\textcolor{keyword}{const} \textcolor{keywordtype}{void}* base);
00171 
00172 \textcolor{comment}{/*}
00173 \textcolor{comment}{ * alt\_irq\_cpu\_enable\_interrupts() enables the CPU to start taking interrupts.}
00174 \textcolor{comment}{ */}
00175 \textcolor{keyword}{static} ALT_INLINE \textcolor{keywordtype}{void} ALT_ALWAYS_INLINE 
00176        alt_irq_cpu_enable_interrupts (\textcolor{keywordtype}{void})
00177 \{
00178     NIOS2_WRITE_STATUS(NIOS2_STATUS_PIE_MSK
00179 #\textcolor{keywordflow}{if} defined(NIOS2\_EIC\_PRESENT) && (NIOS2\_NUM\_OF\_SHADOW\_REG\_SETS > 0)
00180     | NIOS2_STATUS_RSIE_MSK
00181 #endif      
00182       );
00183 \}
00184 
00185 
00186 \textcolor{comment}{/*}
00187 \textcolor{comment}{ * Prototypes for the enhanced interrupt API.}
00188 \textcolor{comment}{ */}
00189 \textcolor{preprocessor}{#ifdef ALT\_ENHANCED\_INTERRUPT\_API\_PRESENT}
00190 \textcolor{comment}{/*}
00191 \textcolor{comment}{ * alt\_ic\_isr\_register() can be used to register an interrupt handler. If the}
00192 \textcolor{comment}{ * function is succesful, then the requested interrupt will be enabled upon }
00193 \textcolor{comment}{ * return.}
00194 \textcolor{comment}{ */}
00195 \textcolor{keyword}{extern} \textcolor{keywordtype}{int} alt\_ic\_isr\_register(alt_u32 ic\_id,
00196                         alt_u32 irq,
00197                         alt_isr_func isr,
00198                         \textcolor{keywordtype}{void} *isr\_context,
00199                         \textcolor{keywordtype}{void} *flags);
00200 
00201 \textcolor{comment}{/* }
00202 \textcolor{comment}{ * alt\_ic\_irq\_enable() and alt\_ic\_irq\_disable() enable/disable a specific }
00203 \textcolor{comment}{ * interrupt by using IRQ port and interrupt controller instance.}
00204 \textcolor{comment}{ */}
00205 \textcolor{keywordtype}{int} alt\_ic\_irq\_enable (alt_u32 ic\_id, alt_u32 irq);
00206 \textcolor{keywordtype}{int} alt\_ic\_irq\_disable(alt_u32 ic\_id, alt_u32 irq);        
00207 
00208  \textcolor{comment}{/* }
00209 \textcolor{comment}{ * alt\_ic\_irq\_enabled() indicates whether a specific interrupt, as}
00210 \textcolor{comment}{ * specified by IRQ port and interrupt controller instance is enabled.}
00211 \textcolor{comment}{ */}        
00212 alt_u32 alt\_ic\_irq\_enabled(alt_u32 ic\_id, alt_u32 irq);
00213 
00214 \textcolor{preprocessor}{#else }
00215 \textcolor{comment}{/*}
00216 \textcolor{comment}{ * Prototypes for the legacy interrupt API.}
00217 \textcolor{comment}{ */}
00218 \textcolor{preprocessor}{#include "priv/alt_legacy_irq.h"}
00219 \textcolor{preprocessor}{#endif }
00220 
00221 
00222 \textcolor{comment}{/*}
00223 \textcolor{comment}{ * alt\_irq\_pending() returns a bit list of the current pending interrupts.}
00224 \textcolor{comment}{ * This is used by alt\_irq\_handler() to determine which registered interrupt}
00225 \textcolor{comment}{ * handlers should be called.}
00226 \textcolor{comment}{ *}
00227 \textcolor{comment}{ * This routine is only available for the Nios II internal interrupt}
00228 \textcolor{comment}{ * controller.}
00229 \textcolor{comment}{ */}
00230 \textcolor{preprocessor}{#ifndef NIOS2\_EIC\_PRESENT}
00231 \textcolor{keyword}{static} ALT_INLINE alt_u32 ALT_ALWAYS_INLINE alt_irq_pending (\textcolor{keywordtype}{void})
00232 \{
00233   alt_u32 active;
00234 
00235   NIOS2_READ_IPENDING (active);
00236 
00237   \textcolor{keywordflow}{return} active;
00238 \}
00239 \textcolor{preprocessor}{#endif }
00240 
00241 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00242 \}
00243 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* \_\_cplusplus */}\textcolor{preprocessor}{}
00244 
00245 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* \_\_ALT\_IRQ\_H\_\_ */}\textcolor{preprocessor}{}
\end{DoxyCode}
